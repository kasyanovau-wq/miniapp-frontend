<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>12‑30 Mini App (Read-only MVP)</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; padding:16px;}
      .card{border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,.08); padding:16px; margin:12px 0;}
      button{padding:10px 14px; border:none; border-radius:12px; cursor:pointer}
      input{padding:10px; border-radius:12px; border:1px solid #ccc; width:100%}
      .row{display:flex; gap:12px;} .row>*{flex:1;}
      .muted{opacity:.7}
      nav{display:flex; gap:8px; margin-bottom:8px}
      nav button{background:#eee}
      nav button.active{background:#ddd; font-weight:600}
      pre{white-space:pre-wrap; word-break:break-word; background:#f7f7f7; padding:8px; border-radius:8px;}
    </style>
  </head>
  <body>
    <h2>12‑30 — Mini App (Read‑only MVP)</h2>
    <p class="muted">Profile · My Orders · My Sales — data comes from your backend + Tilda.</p>

    <div class="card">
      <label>API Base URL</label>
      <input id="apiBase" value="https://YOUR-BACKEND-URL" />
      <div style="margin-top:8px">
        <button id="saveApiBase">Use this API</button>
      </div>
    </div>

    <div class="card">
      <nav>
        <button id="tabProfile" class="active">Profile</button>
        <button id="tabOrders">My Orders</button>
        <button id="tabSales">My Sales</button>
      </nav>

      <div id="profileView">
        <p><b>Telegram User</b></p>
        <pre id="tgUser">(open inside Telegram to see identity)</pre>
        <button id="btnRefreshMe">Refresh Profile</button>
      </div>

      <div id="ordersView" style="display:none">
        <p><b>My Orders</b></p>
        <pre id="ordersBox">No data yet</pre>
        <button id="btnLoadOrders">Load Orders</button>
      </div>

      <div id="salesView" style="display:none">
        <p><b>My Sales</b></p>
        <pre id="salesBox">No data yet</pre>
        <button id="btnLoadSales">Load Sales</button>
      </div>
    </div>

    <script>
      const tg = window.Telegram?.WebApp;
      if (tg) { tg.expand(); tg.ready(); }

      const apiBaseInput = document.getElementById('apiBase');
      const saveApiBaseBtn = document.getElementById('saveApiBase');
      const tgUserEl = document.getElementById('tgUser');

      let API_BASE = localStorage.getItem('API_BASE') || apiBaseInput.value;
      apiBaseInput.value = API_BASE;

      const initPayload = () => ({
        initData: tg?.initData || '',
        initDataUnsafe: tg?.initDataUnsafe || {},
      });

      function showUser() {
        tgUserEl.textContent = JSON.stringify(tg?.initDataUnsafe?.user || { note: "Run inside Telegram to see user" }, null, 2);
      }
      showUser();

      async function post(path, body) {
        const res = await fetch(API_BASE + path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...body, ...initPayload() }),
        });
        if (!res.ok) throw new Error(await res.text());
        return res.json();
      }

      document.getElementById('btnRefreshMe').onclick = async () => {
        try {
          const out = await post('/api/me', {});
          alert('Profile updated for ' + (out?.user?.username || out?.user?.id));
        } catch (e) { alert(e.message); }
      };

      document.getElementById('btnLoadOrders').onclick = async () => {
        try {
          const out = await post('/api/me/orders', {});
          document.getElementById('ordersBox').textContent = JSON.stringify(out, null, 2);
        } catch (e) { alert(e.message); }
      };

      document.getElementById('btnLoadSales').onclick = async () => {
        try {
          const out = await post('/api/me/sales', {});
          document.getElementById('salesBox').textContent = JSON.stringify(out, null, 2);
        } catch (e) { alert(e.message); }
      };

      saveApiBaseBtn.onclick = () => {
        API_BASE = apiBaseInput.value.trim();
        localStorage.setItem('API_BASE', API_BASE);
        alert('Saved!');
      };

      // tabs
      function setTab(k){
        document.getElementById('tabProfile').classList.toggle('active', k==='p');
        document.getElementById('tabOrders').classList.toggle('active', k==='o');
        document.getElementById('tabSales').classList.toggle('active', k==='s');
        document.getElementById('profileView').style.display = (k==='p')?'block':'none';
        document.getElementById('ordersView').style.display = (k==='o')?'block':'none';
        document.getElementById('salesView').style.display = (k==='s')?'block':'none';
      }
      document.getElementById('tabProfile').onclick = ()=>setTab('p');
      document.getElementById('tabOrders').onclick = ()=>setTab('o');
      document.getElementById('tabSales').onclick = ()=>setTab('s');
    </script>
  </body>
</html>
